<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>船舶地图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
        .leaflet-container {
            background: #1e40af;
        }
        .leaflet-control-zoom {
            border: none !important;
            background: rgba(0,0,0,0.7) !important;
            backdrop-filter: blur(10px);
        }
        .leaflet-control-zoom a {
            background: rgba(255,255,255,0.1) !important;
            color: white !important;
            border: 1px solid rgba(255,255,255,0.2) !important;
        }
        .leaflet-control-zoom a:hover {
            background: rgba(79,209,199,0.8) !important;
        }
        .ship-marker {
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .ship-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .leaflet-popup-content-wrapper {
            background: rgba(0,0,0,0.9) !important;
            border: 1px solid rgba(79,209,199,0.5) !important;
            border-radius: 8px !important;
            backdrop-filter: blur(10px);
        }
        .leaflet-popup-content {
            color: white !important;
            margin: 12px !important;
        }
        .leaflet-popup-tip {
            background: rgba(0,0,0,0.9) !important;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script>
        // 初始化地图
        const map = L.map('map').setView([26.0614, 119.3061], 13);
        
        // 添加高德地图瓦片层
        L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            attribution: '&copy; 高德地图',
            subdomains: ['1', '2', '3', '4'],
            maxZoom: 18
        }).addTo(map);
        
        // 获取URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const shipsData = urlParams.get('ships');
        const centerData = urlParams.get('center');
        
        let ships = [];
        let center = { lat: 26.0614, lng: 119.3061 };
        
        try {
            if (shipsData) {
                ships = JSON.parse(decodeURIComponent(shipsData));
            }
            if (centerData) {
                center = JSON.parse(decodeURIComponent(centerData));
                map.setView([center.lat, center.lng], 13);
            }
        } catch (error) {
            console.error('解析参数失败:', error);
        }
        
        // 添加船只标记
        ships.forEach(ship => {
            // 创建船体图标 - 现代化流线型设计 (增大尺寸)
            const shipIcon = L.divIcon({
                className: 'ship-icon',
                html: `
                    <div style="
                        width: 48px;
                        height: 48px;
                        position: relative;
                        transform: rotate(${ship.course || 0}deg);
                    ">
                        <svg width="48" height="48" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- 船体 -->
                            <path d="M16 6C12 6 8 12 8 22L16 26L24 22C24 12 20 6 16 6Z" fill="${getShipColor(ship.status)}" stroke="white" stroke-width="2"/>
                            <!-- 船舱 -->
                            <rect x="12" y="12" width="8" height="4" fill="white" fill-opacity="0.8" rx="1"/>
                            <!-- 桅杆 -->
                            <rect x="15" y="8" width="2" height="6" fill="white"/>
                            <!-- 方向指示 -->
                            <polygon points="16,8 14,10 18,10" fill="white"/>
                        </svg>
                    </div>
                `,
                iconSize: [48, 48],
                iconAnchor: [24, 24]
            });
            
            const marker = L.marker([ship.lat, ship.lng], { icon: shipIcon }).addTo(map);
            
            // 添加弹窗
            marker.bindPopup(`
                <div style="color: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <h3 style="margin: 0 0 8px 0; color: #4FD1C7;">${ship.name}</h3>
                    <p style="margin: 4px 0;">状态: <span style="color: ${getShipColor(ship.status)};">${getStatusText(ship.status)}</span></p>
                    <p style="margin: 4px 0;">速度: <span style="color: #4FD1C7;">${ship.speed} 节</span></p>
                    <p style="margin: 4px 0;">电量: <span style="color: ${getBatteryColor(ship.battery)};">${ship.battery}%</span></p>
                    <p style="margin: 4px 0;">航向: <span style="color: #4FD1C7;">${ship.course}°</span></p>
                </div>
            `);
            
            // 点击事件
            marker.on('click', function() {
                // 向父页面发送消息
                if (window.parent) {
                    window.parent.postMessage({
                        type: 'shipClick',
                        shipId: ship.id,
                        ship: ship
                    }, '*');
                }
            });
        });
        
        function getShipColor(status) {
            switch (status) {
                case 'online':
                    return '#10B981';
                case 'warning':
                    return '#F59E0B';
                case 'offline':
                    return '#6B7280';
                default:
                    return '#4FD1C7';
            }
        }
        
        function getStatusText(status) {
            switch (status) {
                case 'online':
                    return '在线';
                case 'warning':
                    return '警告';
                case 'offline':
                    return '离线';
                default:
                    return '未知';
            }
        }
        
        function getBatteryColor(battery) {
            if (battery < 20) return '#EF4444';
            if (battery < 50) return '#F59E0B';
            return '#10B981';
        }
        
        // 监听来自父页面的消息
        window.addEventListener('message', function(event) {
            if (event.data.type === 'updateShips') {
                // 更新船只位置
                console.log('更新船只位置:', event.data.ships);
            } else if (event.data.type === 'zoomIn') {
                map.zoomIn();
            } else if (event.data.type === 'zoomOut') {
                map.zoomOut();
            } else if (event.data.type === 'centerMap') {
                map.setView([center.lat, center.lng], 13);
            }
        });
    </script>
</body>
</html>
