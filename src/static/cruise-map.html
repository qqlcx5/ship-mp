<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>巡航地图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
        .leaflet-container {
            background: #1e40af;
        }
        .leaflet-control-zoom {
            border: none !important;
            background: rgba(0,0,0,0.7) !important;
            backdrop-filter: blur(10px);
        }
        .leaflet-control-zoom a {
            background: rgba(255,255,255,0.1) !important;
            color: white !important;
            border: 1px solid rgba(255,255,255,0.2) !important;
        }
        .leaflet-control-zoom a:hover {
            background: rgba(79,209,199,0.8) !important;
        }
        .waypoint-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .waypoint-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        .leaflet-popup-content-wrapper {
            background: rgba(79,209,199,0.9) !important;
            border: 1px solid rgba(79,209,199,0.5) !important;
            border-radius: 8px !important;
            backdrop-filter: blur(10px);
        }
        .leaflet-popup-content {
            color: white !important;
            margin: 12px !important;
        }
        .leaflet-popup-tip {
            background: rgba(79,209,199,0.9) !important;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script>
        // 初始化地图
        const map = L.map('map').setView([26.0614, 119.3061], 13);
        
        // 添加高德地图瓦片层
        L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            attribution: '&copy; 高德地图',
            subdomains: ['1', '2', '3', '4'],
            maxZoom: 18
        }).addTo(map);
        
        // 获取URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const shipsData = urlParams.get('ships');
        const waypointsData = urlParams.get('waypoints');
        const routeData = urlParams.get('route');
        const centerData = urlParams.get('center');
        
        let ships = [];
        let waypoints = [];
        let route = [];
        let center = { lat: 26.0614, lng: 119.3061 };
        
        try {
            if (shipsData) {
                ships = JSON.parse(decodeURIComponent(shipsData));
            }
            if (waypointsData) {
                waypoints = JSON.parse(decodeURIComponent(waypointsData));
            }
            if (routeData) {
                route = JSON.parse(decodeURIComponent(routeData));
            }
            if (centerData) {
                center = JSON.parse(decodeURIComponent(centerData));
                map.setView([center.lat, center.lng], 13);
            }
        } catch (error) {
            console.error('解析参数失败:', error);
        }
        
        // 添加船只标记
        ships.forEach(ship => {
            const marker = L.circleMarker([ship.lat, ship.lng], {
                radius: 8,
                fillColor: getShipColor(ship.status),
                color: 'white',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            
            marker.bindPopup(`
                <div style="color: white;">
                    <h3 style="margin: 0 0 8px 0; color: white;">${ship.name}</h3>
                    <p style="margin: 4px 0;">状态: ${getStatusText(ship.status)}</p>
                    <p style="margin: 4px 0;">速度: ${ship.speed} 节</p>
                    <p style="margin: 4px 0;">电量: ${ship.battery}%</p>
                </div>
            `);
        });
        
        // 添加航点标记
        waypoints.forEach((waypoint, index) => {
            const marker = L.circleMarker([waypoint.lat, waypoint.lng], {
                radius: 12,
                fillColor: getWaypointColor(index),
                color: 'white',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            
            // 添加航点编号
            const divIcon = L.divIcon({
                className: 'waypoint-number',
                html: `<div style="
                    width: 24px; 
                    height: 24px; 
                    border-radius: 50%; 
                    background: ${getWaypointColor(index)}; 
                    border: 3px solid white; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    color: white; 
                    font-weight: bold; 
                    font-size: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                ">${index + 1}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const numberMarker = L.marker([waypoint.lat, waypoint.lng], { icon: divIcon }).addTo(map);
            
            numberMarker.bindPopup(`
                <div style="color: white;">
                    <h3 style="margin: 0 0 8px 0; color: white;">${waypoint.name}</h3>
                    <p style="margin: 4px 0;">速度: ${waypoint.speed} 节</p>
                    <p style="margin: 4px 0;">等待时间: ${waypoint.waitTime} 秒</p>
                    <p style="margin: 4px 0;">坐标: ${waypoint.lat.toFixed(4)}, ${waypoint.lng.toFixed(4)}</p>
                </div>
            `);
            
            // 点击事件
            numberMarker.on('click', function() {
                if (window.parent) {
                    window.parent.postMessage({
                        type: 'waypointClick',
                        waypointId: waypoint.id,
                        waypoint: waypoint
                    }, '*');
                }
            });
        });
        
        // 绘制路径
        if (route.length > 1) {
            const routeLine = L.polyline(route.map(point => [point.lat, point.lng]), {
                color: '#4FD1C7',
                weight: 3,
                opacity: 0.8,
                dashArray: '8, 4'
            }).addTo(map);
            
            // 添加箭头
            const decorator = L.polylineDecorator(routeLine, {
                patterns: [
                    {
                        offset: 25,
                        repeat: 50,
                        symbol: L.Symbol.arrowHead({
                            pixelSize: 15,
                            polygon: false,
                            pathOptions: {
                                stroke: true,
                                weight: 2,
                                color: '#4FD1C7'
                            }
                        })
                    }
                ]
            });
            
            if (L.polylineDecorator) {
                decorator.addTo(map);
            }
        }
        
        // 地图点击事件（添加航点）
        map.on('click', function(e) {
            if (window.parent) {
                window.parent.postMessage({
                    type: 'waypointAdd',
                    lat: e.latlng.lat,
                    lng: e.latlng.lng
                }, '*');
            }
        });
        
        function getShipColor(status) {
            switch (status) {
                case 'online':
                    return '#10B981';
                case 'warning':
                    return '#F59E0B';
                case 'offline':
                    return '#6B7280';
                default:
                    return '#4FD1C7';
            }
        }
        
        function getWaypointColor(index) {
            const colors = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899'];
            return colors[index % colors.length];
        }
        
        function getStatusText(status) {
            switch (status) {
                case 'online':
                    return '在线';
                case 'warning':
                    return '警告';
                case 'offline':
                    return '离线';
                default:
                    return '未知';
            }
        }
        
        // 监听来自父页面的消息
        window.addEventListener('message', function(event) {
            if (event.data.type === 'updateWaypoints') {
                // 更新航点
                console.log('更新航点:', event.data.waypoints);
            } else if (event.data.type === 'zoomIn') {
                map.zoomIn();
            } else if (event.data.type === 'zoomOut') {
                map.zoomOut();
            } else if (event.data.type === 'centerMap') {
                map.setView([center.lat, center.lng], 13);
            }
        });
    </script>
</body>
</html>
