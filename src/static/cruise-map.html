<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>巡航地图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
        .leaflet-container {
            background: #1e40af;
        }
        .leaflet-control-zoom {
            border: none !important;
            background: rgba(0,0,0,0.7) !important;
            backdrop-filter: blur(10px);
        }
        .leaflet-control-zoom a {
            background: rgba(255,255,255,0.1) !important;
            color: white !important;
            border: 1px solid rgba(255,255,255,0.2) !important;
        }
        .leaflet-control-zoom a:hover {
            background: rgba(79,209,199,0.8) !important;
        }
        .waypoint-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .waypoint-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        .leaflet-popup-content-wrapper {
            background: rgba(79,209,199,0.9) !important;
            border: 1px solid rgba(79,209,199,0.5) !important;
            border-radius: 8px !important;
            backdrop-filter: blur(10px);
        }
        .leaflet-popup-content {
            color: white !important;
            margin: 12px !important;
        }
        .leaflet-popup-tip {
            background: rgba(79,209,199,0.9) !important;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script>
        // 初始化地图
        const map = L.map('map').setView([26.0614, 119.3061], 13);
        
        // 添加高德地图瓦片层
        L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            attribution: '&copy; 高德地图',
            subdomains: ['1', '2', '3', '4'],
            maxZoom: 18
        }).addTo(map);
        
        // 获取URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const shipsData = urlParams.get('ships');
        const waypointsData = urlParams.get('waypoints');
        const routeData = urlParams.get('route');
        const centerData = urlParams.get('center');
        
        let ships = [];
        let waypoints = [];
        let route = [];
        let center = { lat: 26.0614, lng: 119.3061 };
        
        try {
            if (shipsData) {
                ships = JSON.parse(decodeURIComponent(shipsData));
            }
            if (waypointsData) {
                waypoints = JSON.parse(decodeURIComponent(waypointsData));
            }
            if (routeData) {
                route = JSON.parse(decodeURIComponent(routeData));
            }
            if (centerData) {
                center = JSON.parse(decodeURIComponent(centerData));
                map.setView([center.lat, center.lng], 13);
            }
        } catch (error) {
            console.error('解析参数失败:', error);
        }
        
        // 添加船只标记
        ships.forEach(ship => {
            // 创建船体图标 - 现代化流线型设计 (增大尺寸)
            const shipIcon = L.divIcon({
                className: 'ship-icon',
                html: `
                    <div style="
                        width: 48px;
                        height: 48px;
                        position: relative;
                        transform: rotate(${ship.course || 0}deg);
                    ">
                        <svg width="48" height="48" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- 船体 -->
                            <path d="M16 6C12 6 8 12 8 22L16 26L24 22C24 12 20 6 16 6Z" fill="${getShipColor(ship.status)}" stroke="white" stroke-width="2"/>
                            <!-- 船舱 -->
                            <rect x="12" y="12" width="8" height="4" fill="white" fill-opacity="0.8" rx="1"/>
                            <!-- 桅杆 -->
                            <rect x="15" y="8" width="2" height="6" fill="white"/>
                            <!-- 方向指示 -->
                            <polygon points="16,8 14,10 18,10" fill="white"/>
                        </svg>
                    </div>
                `,
                iconSize: [48, 48],
                iconAnchor: [24, 24]
            });
            
            const marker = L.marker([ship.lat, ship.lng], { icon: shipIcon }).addTo(map);
            
            marker.bindPopup(`
                <div style="color: white;">
                    <h3 style="margin: 0 0 8px 0; color: white;">${ship.name}</h3>
                    <p style="margin: 4px 0;">状态: ${getStatusText(ship.status)}</p>
                    <p style="margin: 4px 0;">速度: ${ship.speed} 节</p>
                    <p style="margin: 4px 0;">电量: ${ship.battery}%</p>
                </div>
            `);
        });
        
        // 添加航点标记
        waypoints.forEach((waypoint, index) => {
            const marker = L.circleMarker([waypoint.lat, waypoint.lng], {
                radius: 12,
                fillColor: getWaypointColor(index),
                color: 'white',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            
            // 添加真实小船图标，编号在右下方
            const divIcon = L.divIcon({
                className: 'waypoint-real-boat',
                html: `
                    <div style="
                        width: 48px;
                        height: 48px;
                        position: relative;
                    ">
                        <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- 船体主体 -->
                            <path d="M24 12C18 12 12 18 12 32L24 38L36 32C36 18 30 12 24 12Z" fill="${getWaypointColor(index)}" stroke="white" stroke-width="2"/>
                            <!-- 船舱 -->
                            <rect x="19" y="20" width="10" height="6" fill="white" fill-opacity="0.9" rx="2"/>
                            <!-- 桅杆 -->
                            <rect x="23" y="14" width="3" height="8" fill="white"/>
                            <!-- 船头 -->
                            <path d="M12 28L8 26L12 32Z" fill="${getWaypointColor(index)}"/>
                            <!-- 船尾 -->
                            <path d="M36 28L40 26L36 32Z" fill="${getWaypointColor(index)}"/>
                        </svg>
                        <!-- 小编号在右下方 -->
                        <div style="
                            position: absolute;
                            right: -6px;
                            bottom: -6px;
                            width: 16px;
                            height: 16px;
                            background: white;
                            border: 1px solid ${getWaypointColor(index)};
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            font-weight: bold;
                            color: ${getWaypointColor(index)};
                            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                        ">${index + 1}</div>
                    </div>
                `,
                iconSize: [48, 48],
                iconAnchor: [24, 24]
            });
            
            const numberMarker = L.marker([waypoint.lat, waypoint.lng], { icon: divIcon }).addTo(map);
            
            numberMarker.bindPopup(`
                <div style="color: white;">
                    <h3 style="margin: 0 0 8px 0; color: white;">${waypoint.name}</h3>
                    <p style="margin: 4px 0;">速度: ${waypoint.speed} 节</p>
                    <p style="margin: 4px 0;">等待时间: ${waypoint.waitTime} 秒</p>
                    <p style="margin: 4px 0;">坐标: ${waypoint.lat.toFixed(4)}, ${waypoint.lng.toFixed(4)}</p>
                </div>
            `);
            
            // 点击事件
            numberMarker.on('click', function() {
                if (window.parent) {
                    window.parent.postMessage({
                        type: 'waypointClick',
                        waypointId: waypoint.id,
                        waypoint: waypoint
                    }, '*');
                }
            });
        });
        
        // 绘制路径
        if (route.length > 1) {
            const routeLine = L.polyline(route.map(point => [point.lat, point.lng]), {
                color: '#4FD1C7',
                weight: 3,
                opacity: 0.8,
                dashArray: '8, 4'
            }).addTo(map);
            
            // 添加箭头
            const decorator = L.polylineDecorator(routeLine, {
                patterns: [
                    {
                        offset: 25,
                        repeat: 50,
                        symbol: L.Symbol.arrowHead({
                            pixelSize: 15,
                            polygon: false,
                            pathOptions: {
                                stroke: true,
                                weight: 2,
                                color: '#4FD1C7'
                            }
                        })
                    }
                ]
            });
            
            if (L.polylineDecorator) {
                decorator.addTo(map);
            }
        }
        
        // 海洋区域检测函数（基于坐标和地图瓦片）
        async function isInOcean(lat, lng) {
            // 简化的海洋检测：检查坐标是否在水域范围内
            // 基于中国沿海区域的粗略判断
            const oceanBounds = {
                minLat: 18.0,
                maxLat: 42.0,
                minLng: 105.0,
                maxLng: 125.0
            };
            
            // 检查是否在合理的水域范围内
            if (lat < oceanBounds.minLat || lat > oceanBounds.maxLat || 
                lng < oceanBounds.minLng || lng > oceanBounds.maxLng) {
                return false;
            }
            
            // 排除主要陆地（简化的中国海岸线检测）
            const landAreas = [
                // 台湾岛
                { minLat: 21.8, maxLat: 25.4, minLng: 119.9, maxLng: 122.0 },
                // 海南岛
                { minLat: 18.1, maxLat: 20.2, minLng: 108.6, maxLng: 111.1 },
                // 其他主要陆地
                { minLat: 25.0, maxLat: 41.0, minLng: 118.0, maxLng: 123.0 }
            ];
            
            for (const area of landAreas) {
                if (lat >= area.minLat && lat <= area.maxLat && 
                    lng >= area.minLng && lng <= area.maxLng) {
                    return false;
                }
            }
            
            return true;
        }

        // 地图点击事件（添加航点 - 限制在海上）
        map.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // 检查是否在海洋区域
            const isOcean = await isInOcean(lat, lng);
            
            if (isOcean) {
                if (window.parent) {
                    window.parent.postMessage({
                        type: 'waypointAdd',
                        lat: lat,
                        lng: lng
                    }, '*');
                }
            } else {
                // 显示提示信息
                L.popup()
                    .setLatLng([lat, lng])
                    .setContent('<div style="color: white;">⚠️ 航点只能在海上添加</div>')
                    .openOn(map);
            }
        });
        
        function getShipColor(status) {
            switch (status) {
                case 'online':
                    return '#10B981';
                case 'warning':
                    return '#F59E0B';
                case 'offline':
                    return '#6B7280';
                default:
                    return '#4FD1C7';
            }
        }
        
        function getWaypointColor(index) {
            const colors = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899'];
            return colors[index % colors.length];
        }
        
        function getStatusText(status) {
            switch (status) {
                case 'online':
                    return '在线';
                case 'warning':
                    return '警告';
                case 'offline':
                    return '离线';
                default:
                    return '未知';
            }
        }
        
        // 监听来自父页面的消息
        window.addEventListener('message', function(event) {
            if (event.data.type === 'updateWaypoints') {
                // 更新航点
                console.log('更新航点:', event.data.waypoints);
            } else if (event.data.type === 'zoomIn') {
                map.zoomIn();
            } else if (event.data.type === 'zoomOut') {
                map.zoomOut();
            } else if (event.data.type === 'centerMap') {
                map.setView([center.lat, center.lng], 13);
            }
        });
    </script>
</body>
</html>
